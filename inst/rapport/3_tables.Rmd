# (PART) Summarising tables {- #p:summarising-tables}

```{r helper-functions}
estimate <- function(mean, round = 1) {
  round(exp(mean), round)
}
publication <- function(mean, magnitude) {
  magnitude <- magnitude - 1
  round(exp(mean) / 10 ^ magnitude) * 10 ^ magnitude
}
```

# Average yearly change based on monthly totals {#ch:yearly-change}

## Yearly change over the last twelve years {#s:yearly-change-12}

```{r monthly-trend-12-yearly, results = "asis"}
results %>%
  filter(ModelType == "imputed trend: Total ~ Year + Month", Duration == 12,
         Parameter == "cYear") %>%
  mutate(Class = classification(LCL, UCL, log(0.75) / Duration[1])) %>%
  mutate_at(c("Estimate", "LCL", "UCL"), change) %>%
  transmute(
    Area = LocationGroup, Species = scientific_name,
    Estimate, Class,
    Change = sprintf("%+.0f%% (%+.0f%%; %+.0f%%)",
                     ifelse(Estimate > 1e5, Inf, Estimate), LCL,
                     ifelse(UCL > 1e5, Inf, UCL))
  ) %>%
  arrange(Area, Class, desc(Estimate)) %>%
  mutate(
    Species = paste0("_", Species, "_"),
    Class = format(Class, type = "markdown")
  ) %>%
  select(-Estimate) %>%
  group_by(Area) %>%
  nest() -> tab_ya12
junk <- sapply(
  seq_along(tab_ya12$Area),
  function(i) {
    cat("###", as.character(tab_ya12$Area[i]), "\n\n")
    print(kable(
      tab_ya12$data[[i]], format = "pandoc", align = "lcc",
      label = paste0("monthly-trend-12-yearly",
                     str_replace(tab_ya12$Area[i], " ", "-"), sep = "-"),
      caption = paste("Average yearly change over the last twelve year based on
                      monthly totals for", tab_ya12$Area[i])))
    cat("\n\n")
  }
)
```

## Yearly change over the entire dataset {#s:yearly-change-tot}

```{r monthly-trend-all-yearly, results = "asis"}
results %>%
  filter(ModelType == "imputed trend: Total ~ Year + Month",
         Parameter == "cYear") %>%
  group_by(SpeciesGroup) %>%
  filter(Duration == max(Duration)) %>%
  ungroup() %>%
  mutate(
    Class = pmap(
      list(LCL, UCL, log(0.75) / Duration),
      classification
    ) %>%
      effectclass:::unlist.effectclass()
  ) %>%
  mutate_at(c("Estimate", "LCL", "UCL"), change) %>%
  transmute(
    Area = LocationGroup, Species = scientific_name,
    Class, Estimate,
    Change = sprintf("%+.0f%% (%+.0f%%; %+.0f%%)",
                     ifelse(Estimate > 1e5, Inf, Estimate), LCL,
                     ifelse(UCL > 1e5, Inf, UCL))
  ) %>%
  arrange(Area, Class, desc(Estimate)) %>%
  mutate(
    Species = paste0("_", Species, "_"),
    Class = format(Class, type = "markdown")
  ) %>%
  select(-Estimate) %>%
  group_by(Area) %>%
  nest() -> tab_yatot
junk <- sapply(
  seq_along(tab_yatot$Area),
  function(i) {
    cat("###", as.character(tab_yatot$Area[i]), "\n\n")
    print(kable(
      tab_yatot$data[[i]], format = "pandoc", align = "lcc",
      label = paste0("monthly-trend-all-yearly-total",
                     str_replace(tab_yatot$Area[i], " ", "-"), sep = "-"),
      caption = paste("Average yearly change over the entire dataset based on
                      monthly totals for", tab_yatot$Area[i])))
    cat("\n\n")
  }
)
```

# Total linear change based on monthly totals {#ch:total-change}

## Total change over the last twelve years

```{r monthly-trend-12-yearly-total, results = "asis"}
results %>%
  filter(ModelType == "imputed trend: Total ~ Year + Month", Duration == 12,
         Parameter == "cYear") %>%
  mutate(
    Class = classification(LCL, UCL, log(0.75) / Duration[1]),
    Estimate = total_change(Estimate, Duration),
    LCL = total_change(LCL, Duration),
    UCL = total_change(UCL, Duration)
  ) %>%
  transmute(
    Area = LocationGroup, Species = scientific_name,
    Class, Estimate,
    Change = sprintf("%+.0f%% (%+.0f%%; %+.0f%%)",
                     ifelse(Estimate > 1e5, Inf, Estimate), LCL,
                     ifelse(UCL > 1e5, Inf, UCL))
  ) %>%
  arrange(Area, Class, desc(Estimate)) %>%
  mutate(
    Species = paste0("_", Species, "_"),
    Class = format(Class, type = "markdown")
  ) %>%
  select(-Estimate) %>%
  group_by(Area) %>%
  nest() -> tab_yt12
junk <- sapply(
  seq_along(tab_yt12$Area),
  function(i) {
    cat("###", as.character(tab_yt12$Area[i]), "\n\n")
    print(kable(
      tab_yt12$data[[i]], format = "pandoc", align = "lcc",
      label = paste0("monthly-trend-12-total",
                     str_replace(tab_yt12$Area[i], " ", "-"), sep = "-"),
      caption = paste("Average total change over the last twelve year based on
                      monthly totals for", tab_yt12$Area[i])))
    cat("\n\n")
  }
)
```

## Total linear change over the entire dataset

```{r monthly-trend-all-yearly-total, results = "asis"}
results %>%
  filter(ModelType == "imputed trend: Total ~ Year + Month",
         Parameter == "cYear") %>%
  group_by(SpeciesGroup) %>%
  filter(Duration == max(Duration)) %>%
  ungroup() %>%
  mutate(
    Class = pmap(
      list(LCL, UCL, log(0.75) / Duration),
      classification
    ) %>%
      effectclass:::unlist.effectclass(),
    Estimate = total_change(Estimate, Duration),
    LCL = total_change(LCL, Duration),
    UCL = total_change(UCL, Duration)
  ) %>%
  transmute(
    Area = LocationGroup, Species = scientific_name,
    Class, Estimate,
    Change = sprintf("%+.0f%% (%+.0f%%; %+.0f%%)",
                     ifelse(Estimate > 1e5, Inf, Estimate), LCL,
                     ifelse(UCL > 1e5, Inf, UCL))
  ) %>%
  arrange(Area, Class, desc(Estimate)) %>%
  mutate(
    Species = paste0("_", Species, "_"),
    Class = format(Class, type = "markdown")
  ) %>%
  select(-Estimate) %>%
  group_by(Area) %>%
  nest() -> tab_yttot
junk <- sapply(
  seq_along(tab_yttot$Area),
  function(i) {
    cat("###", as.character(tab_yttot$Area[i]), "\n\n")
    print(kable(
      tab_yttot$data[[i]], format = "pandoc", align = "lcc",
      label = paste0("monthly-trend-all-total",
                     str_replace(tab_yttot$Area[i], " ", "-"), sep = "-"),
      caption = paste("Average total change over the entire dataset based on
                      monthly totals for", tab_yttot$Area[i])))
    cat("\n\n")
  }
)
```

# Winter maxima {#ch:wintermaxima}

## Average winter maximum over the last five years {#s:wintermaxima}

```{r wintermax, results = "asis"}
results %>%
  filter(ModelType == "imputed average: Total ~ cPeriod",
         Parameter == "(Intercept)") %>%
  mutate(
    UCL = ifelse(UCL > 20, Inf, UCL),
    Magnitude = floor(log10(exp(UCL))),
    Magnitude = Magnitude - (1.2 * 10 ^ Magnitude > exp(UCL)),
    pX = publication(Estimate, Magnitude),
    pL = publication(LCL, Magnitude),
    pU = publication(UCL, Magnitude)
  ) %>%
  mutate_at(c("Estimate", "LCL", "UCL"), estimate) %>%
  transmute(
    Area = LocationGroup,
    Species = paste0("_", scientific_name, "_"),
    Estimate,
    Detail = sprintf("%.0f (%.0f; %.0f)", Estimate, LCL, UCL),
    "For publication" = sprintf("%.0f (%.0f; %.0f)", pX, pL, pU)
  ) %>%
  arrange(desc(Estimate)) %>%
  select(-Estimate) %>%
  group_by(Area) %>%
  nest() -> tab_wm5
junk <- sapply(
  seq_along(tab_wm5$Area),
  function(i) {
    cat("###", as.character(tab_wm5$Area[i]), "\n\n")
    print(kable(
      tab_wm5$data[[i]], format = "pandoc", align = "lcc",
      label = paste0("wintermax",
                     str_replace(tab_wm5$Area[i], " ", "-"), sep = "-"),
      caption = paste("Average winter maximum over the last five years for",
                      tab_wm5$Area[i])))
    cat("\n\n")
  }
)
```

## Change in average winter maximum over the last two five-year periods {#s:wintermaxima-delta}

```{r wintermax-change, results = "asis"}
results %>%
  filter(ModelType == "imputed average: Total ~ cPeriod",
         Parameter == "cPeriod") %>%
  transmute(
    Area = LocationGroup, Species = scientific_name,
    Class = classification(LCL, UCL, log(0.75)),
    Estimate,
    Change = sprintf("%+.0f%% (%+.0f%%; %+.0f%%)",
                     ifelse(change(Estimate) > 1e5, Inf, change(Estimate)),
                     change(LCL), ifelse(change(UCL) > 1e5, Inf, change(UCL)))
  ) %>%
  arrange(Area, Class, desc(Estimate)) %>%
  mutate(
    Species = paste0("_", Species, "_"),
    Class = format(Class, type = "markdown")
  ) %>%
  select(-Estimate) %>%
  group_by(Area) %>%
  nest() -> tab_wmdelta
junk <- sapply(
  seq_along(tab_wmdelta$Area),
  function(i) {
    cat("###", as.character(tab_wmdelta$Area[i]), "\n\n")
    print(kable(
      tab_wmdelta$data[[i]], format = "pandoc", align = "lcc",
      label = paste0("wintermax-change",
                     str_replace(tab_wmdelta$Area[i], " ", "-"), sep = "-"),
      caption = paste("Change in average wintermax over the last two five-year
                      periods for", tab_wmdelta$Area[i])))
    cat("\n\n")
  }
)
```
